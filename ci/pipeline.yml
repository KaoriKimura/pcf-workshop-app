---
resources:
  - name: pcfapp
    type: git
    source:
      uri: https://github.com/tkaburagi1214/pcf-workshop-app
      branch: master
    check_every: 10s
  - name: deploy-to-cf
    type: cf
    source:
      api: api.sys.pcflab.jp
      username: kab
      password: kab
      organization: handson-instructor
      space: development
      skip_cert_check: true
jobs:
- name: unit-test
  plan:
  - get: pcfapp
    trigger: true
  - task: mvn-test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: maven
      inputs:
      - name: pcfapp
      caches:
      - path: pcfapp/m2   
      run:
        path: bash
        args:
        - -c
        - |
          set -e
          cd pcfapp
          rm -rf ~/.m2
          ln -fs $(pwd)/m2 ~/.m2
          mvn test
- name: build-and-artifact
  plan:
  - get: pcfapp
    passed: [ unit-test ]
    trigger: true
  - task: build
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: maven
      inputs:
      - name: pcfapp
      caches:
      - path: pcfapp/m2   
      run:
        path: bash
        args:
        - -c
        - |
          ls -ltR
          set -e
          cd pcfapp
          rm -rf ~/.m2
          ln -fs $(pwd)/m2 ~/.m2
          mvn clean package
  - put: deploy-to-cf
    params: 
      manifest: pcfapp/manifest.yml
      current_app_name: pcfapp-instructor
